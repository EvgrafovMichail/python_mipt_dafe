# Менеджер пакетов и виртуальное окружение.

В этом семестре нам так или иначе придется работать с библиотеками, не являющимися частью стандартной библиотеки Python (так называемые *third party software*). Минимальный набор действий, которые необходимо совершить для работы с подобными библиотеками - скачивание и установка. Однако, если вы хотите организовать комфортную работу над несколькими проектами с большим числом различных, часто несовместимых между собой, зависимостей, а также иметь возможность поделиться своими проектами с прочими разработчиками - вам необходимо нечто большее, чем простое скачивание и установка пакетов с софтом. Именно этому и будет посвящено наше сегодняшнее занятие. 

## pip

Несмотря на то, что Python обладает очень богатой стандартной библиотекой, существующих модулей порой может быть недостаточно, чтобы решать некоторые специфичные задачи в определенных доменах. Собственно, для решения таких задач силами сообщества Python и разрабатываются различные библиотеки. Сегодня количество библиотек для Python настолько велико, что с большой долей вероятности вы сможете найти готовое программное решение для вашей конкретной проблемы. Так сообществом Python были созданы библиотеки для обработки больших массивов числовых данных, создания и обучения глубоких нейронных сетей, веб-разработки, расчетов передаточных функций в соответствии с теорией автоматического управления и т.д. и т.п.

Для того чтобы как-то облегчить разработчикам сценарии по работе с таким большим многообразием сторонних библиотек, в Python реализован свой собственный пакетный менеджер, который называется PIP. Название утилиты - рекурсивный акроним, который расшифровывается, как *pip install packages* (*pip устанавливает библиотеки*). Т.к. сторонние библиотеки стали настолько важной частью языка, что начиная с версии 3.4 PIP распространяется вместе с интерпретатором. Если вы следовали мануалу по установке [интерпретатора](../../../docs/guide.pdf), то скорее всего pip уже установлен на ваш компьютер. Иначе вам придется установить его вручную самостоятельно. Для этого можно воспользоваться, например, [этим мануалом](https://pip.pypa.io/en/stable/installation/).

### Проверяем наличие pip

Чтобы удостовериться, что PIP установлен и добавлен в path, выполним следующую команду:

*Windows (cmd, не PowerShell)*:
```console
where pip
```

*Linux/MacOS*:
```console
which pip
```

Данная команда позволяет получить абсолютный путь до утилиты PIP. В случае, если на вашем компьютере установлено несколько версий Python, команда выведет несколько путей. Если команда не вывела ни одного пути, значить вам нужно или переустановить pip, или добавить путь до pip в path. На Windows это делается через изменение Переменных локальных сред, на Unix-подобных системах - через редактирование переменной **PATH**. 

### pip install - простейший вид

Обычно перед началом работы над каким-либо проектом на языке Python первое с чего начинают разработку - создание виртуального окружения для данного проекта. Чуть позже мы с вами разберемся, как это работает, и почему это делают, сейчас же не будем особо задумываться и просто выполним команды ниже:

*Windows*:
```console
python -m venv venv
.\venv\Scripts\activate
```

*Linux/MacOS*:
```console
python -m venv venv
source venv/bin/activate
```

После создания и активации виртуального окружения мы можем приступать к скачиванию и установке нужных нам библиотек. Для этого мы можем использовать pip двумя разными способами: как самостоятельную утилиту или как модуль python. Все команды pip могут быть исполнены используя оба этих подхода.

```console
pip install <package> [<package2> <package3> ...]
python -m pip install <package> [<package2> <package3> ...]
```

В обоих случаях нами была выполнена команда `pip install`, которая делает следующее:
- Ищет последнюю версию библиотеки с указанным именем в [PyPI](https://pypi.org/) (Python Packet Index) - специальном удаленном хранилище, в котором разработчики публикуют свои библиотеки;
- Ищет все зависимости для указанной библиотеки;
- Скачивает и устанавливает библиотеку и её зависимости в текущее виртуальное окружение;

В простейшем случае команда `pip install` в качестве аргумента получает имя библиотеки, однако, как видно из примера выше, вы можете передать данной команде сразу несколько идентификаторов пакетов.

### pip list - просмотр текущих зависимостей

С помощью команды `pip list` вы можете получить информацию о библиотеках, установленных в активное виртуальное окружение. Данная информация представляется в виде удобной таблички, в которой также указаны используемые версии библиотек:

*Вызов в консоле*:
```console
pip list
```

*Пример результата*:
```console
Package           Version
----------------- ----------
flake8            6.1.0
matplotlib        3.8.0
numpy             1.26.1
Pillow            10.0.1
pydantic          2.5.2
```

### pip show - просмотр информации о библиотеке

С помощью команды `pip show <package>` вы можете просмотреть мета информацию библиотеки. Это может быть полезным для того, чтобы выяснить, является ли данная библиотека зависимостью для прочих библиотек в текущем виртуальном окружении, и как следствие, можно ли ее безопасно удалить. 

*Вызов в консоле*:
```console
pip show numpy
```

*Пример результата*:
```console
Name: numpy
Version: 1.26.1
Summary: Fundamental package for array computing in Python
Home-page: https://numpy.org
...
Location: C:\Users\Michail\Desktop\mipt\teaching\python_mipt_dafe\venv\Lib\site-packages
Requires:
Required-by: contourpy, matplotlib
```

### pip install - продвинутое использование

#### Custom Index
Не все библиотеки публикуются в PyPI. Иногда существует необходимость в создании своего собственного индекса и распространении определенной библиотеки исключительно через подобный кастомный индекс. Например, подобное имеет место в государственных организациях, связанных с ОПК. В этом случае вы можете явно сообщить pip'у по какому адресу находится требуемый индекс, и где именно следует искать необходимую библиотек. Для этого существует специальная опция `-i` или ее полная форма `--index-url`.

*Пример использования*:
```console
pip install -i https://index-url.com <package-name>
```

#### GitHub
Также некоторое количество полезных библиотек публикуются в виде репозиториев на GitHub. В этом случае у вас также есть возможность установить библиотеку напрямую из репозитория явно сообщив pip'у, что поиск долже происходить на GitHub.

*Пример*:
```console
pip install git+https://github.com/repo/package
```

#### Редактируемый режим
Во время работы над собственной библиотекой, обычно осуществляют установку этой библиотеки в редактируемом режиме в активное виртуальное окружение. Это решает две проблемы:
- При разработке вам не нужно прописывать сложные пути импортов;
- Вам не придется переустанавливать библиотеку каждый раз при внесении изменений, т.к. в редактируемом режиме интерпретатор делает это за вас самостоятельно;

Для установки библиотеки в редактируемом режиме, необходимо переместиться в деректорию с `setup.py` файлом, в котором описаны детали библиотеки, и выполнить команду `pip install` с флагом `-e`.

*Пример*:
```console
pip install -e .
```

В данном примере мы устанавливаем библиотеку, описание которой хранится в текущий директории, а флаг `-e` указывает на то, что мы хотим установить ее в редактируемом режиме.

### Requirements

Обычно для реализации реальных проектов вам требуется использовать большое количество различных библиотек. При отправке кода на удаленный сервер для дальнейшего запуска или при отправке кода другому разработчику, вам необходимо продумать момент с установкой всех зависимостей, необходимых для корректной работы вашего проекта. Для упрощения процесса установки всех зависимостей и были придуманы списки зависимостей.

Список зависимостей представляет собой текстовый файл, в котором перечислены имена библиотек, необходимые для работы с данным проектом. Обычно этот файл называется `requirements` и имеет расширение `.txt`. Название файла - всего лишь соглашение в сообществе, вы можете использовать любое другое имя, однако делать это не рекомендуется.

В простейшем случае список зависимостей выглядит следующим образом:

*requirements.txt*:
```txt
matplotlib
pandas
numpy
```

Список зависимостей легко использовать для настройки виртуального окружения данного проекта. Чтобы скачать нужные библиотеки, необходимо выполнить следующую команду:

```console
pip instal -r requirements.txt
```

Однако, использовать requirements.txt в описанном выше виде не всегда удобно. Подумайте, почему? 

Для избежания проблем с версионированием библиотек достаточно указать необходимую версию через символы `==` в списке последовательностей:

*requirements.txt*:
```txt
matplotlib==3.8.2
pandas==2.1.4
numpy==1.26.3
```

Также существует возможность указывать диапазон версий. В этом случае pip скачает и установит библиотеку, с максимальной версией, удовлетворяющей заданному диапазону. Выглядит это следующим образом.

*requirements.txt*:
```txt
matplotlib>=3.8.2
pandas>=2.1.4, <2.5.1
numpy==1.26.3
```

В этом случае pip установит самую свежую версию библиотеки matplotlib, причем версия будет не ниже версии 3.8.2. Также pip установит самую свежую версию библиотеки pandas, при этом версия будет в диапазоне от 2.1.4 до 2.5.1

При разработке крупного проекта в команде, в requirements.txt могут попадать библиотеки, используемые только при разработке, например, `pytest` - фреймворк для написания юниттестов. Однако серверу, на котором ваше приложение будет запускаться, не обязательно знать об этой зависимости, поскольку на удаленном сервере разработка вестись не будет, и тратить его память на установку pytest не стоит. С этой целью создается два списка зависимостей: requirements.txt - зависимости конечного продукта, requirements_dev.txt - список зависимостей, который используется командой разработки. Содержимое requirements_dev копирует содержание requirements и добавляет зависимости фреймворков разработки. 

Например для такого файла `requirements.txt`:

*requirements.txt*:
```txt
matplotlib
pandas
numpy
```

`requirements_dev.txt` выглядел бы так:

*requirements_dev.txt*:
```txt
matplotlib
pandas
numpy
pytest
```

Чтобы не дублировать содержимое файла `requirements.txt`, мы можем поместить в файл `requirements_dev.txt` следующее:

*requirements_dev.txt*:
```txt
-r requirements.txt
pytest
```

Вести файл requirements.txt можно вручную, самостоятельно добавляя в него устанавливаемые библиотеки по мере добавления все новых и новых зависимостей в ваш проект. Однако существует более удобный способ:

```console
pip freeze > requirements.txt
```

В примере выше мы перенаправили вывод команды `pip freeze`, которая выводит все библиотеки, установленные в активное виртуальное окружение в формате `package==version`, в файл requirements.txt.

### pip uninstall

Для удаления библиотеки достаточно выполнить команду:
```console
pip uninstall <package>
```

Однако будьте внимательны, ведь данная библиотека не всегда может быть безопасно удалена. Иногда установленные библиотеки являются внешними зависимостями для прочих библиотек, в таком случае их удаление может привести к серьезным проблемам. Подумайте, как мы можем узнать, возможно ли безопасное удаление данной библиотеки или нет?

## venv

### Что такое виртуальное окружение и зачем оно нам нужно?

Виртуальное окружение - всего лишь изолированная среда, куда будут устанавиливаться библиотеки. Сам по себе Python не очень хорош в управлении зависимостями, поскольку все скачиваемые библиотеки будут установлены в одну директорию `site-packages/`. Из этого следует большое количество неудобств, которые и призвано решить виртуальное окружение. Давайте рассмотрим самые популярные проблемы, которые можно решить с помощью виртуального окружения:

- **Избежать загрязнения системы**. На некоторых Unix-подобных операционных системах python установлен сразу с некоторыми сторонними пакетами. Как было сказано ранее, все новые библиотеки будут храниться в одной директории, и перемешиваться с этими установленными пакетами. Более того, устанавливамые библиотеки могут затереть предустановленные библиотеки, более релевантные данной системе;

- **Избежать конфликта зависимостей**. Предположим, вы работаете одновременно над двумя проектами. Оба этих проекта требуют numpy для реализации научных вычислений. Однако первый проект требует numpy самой свежей версии, а второй - numpy версии 1.20.1. Из-за того, что все библиотеки хранятся в одном месте, вы не сможете работать одновременно с двумя версиями одной библиотеки, поскольку одна версия всегда будет перезаписывать другую. Тут-то на помощь и приходят виртуальные окружения. Вы можете создать отдельное виртуальное окружение для каждого проекта, установить в них требуемые версии библиотек, и работать одновременно с двумя проектами, не переживая о возможных конфликтах;

- **Менеджмент зависимостей**. Предположим, вы одновременно работаете над двумя проектами: веб-парсер и компьютерная игра в жанре платформер. Для первого проекта вы используете библиотеки `beautiful-soup` и `aiohttp`, для второго - `PyGame`. При этом все библиотеки устанавливаются в глобальное виртуальное окружение. Также предположим, что ваша программа-парсер оказалась настолько полезной, что другие разработчки хотели бы интегрировать её в свои проекты, но для этого им необходимо получить список зависимостей. Вы умеете это делать, и выполняете команду `pip freeze`, однако на выходе, помимо релевантных проекту зависимостей, вы имеете еще и ряд других библиотек, ненужных для работы с вашим парсером, в частности `PyGame`. Чтобы избежать такой ситуации и разделить зависимости, также может быть использовано виртуальное окружение.

### Как с ним работать?

#### Создание
Для создания виртуального окружения используется модуль стандартной библиотеки `venv`. Чтобы создать виртуальное окружение достаточно выполнить команду:

```console
python -m venv <venv-name>
```

`venv-name` - это имя вертуального окружения. Вы можете выбрать произвольное имя, однако чаше всего используются следующие имена: `venv`, `.venv`.

После выполнения этой команды, в текущей директории будет создана папка с именем `venv-name`. 

#### Активация/деактивация

Для того, чтобы все библиотеки были установлены в созданное виртуальное окружения, вы должны его активировать. Для этого достаточно выполнить скрипт `activate`, который хранится в папке виртуального окружения. 

*Windows*:
```console
.\venv-name\Scripts\activate
```

*Linux/MacOS*:
```console
source venv-name/bin/activate
```

После выполнения данного скрипта происходит две вещи:

- В начало содержимого переменной PATH дописывается путь к интерпретатору, который хранится в папке `venv-name`;
- В начале командной строке высвечивается сообщение `(venv-name)`, которое сигнализирует пользователю об активном виртуальном окружении.

При завршении работы с текущем виртуальным окружением, необходимо выполнить команду:

```console
deactivate
```

Эта команда отменит все изменения, которые были внесены в систему при активации виртуального окружения.

## Источники:
- [Real Python. Using Python's pip to Manage Your Projects' Dependencies](https://realpython.com/what-is-pip/)
- [Real Python. Python Virtual Environments: A Primer](https://realpython.com/python-virtual-environments-a-primer/);
